---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(clinsight)
```

## Running ClinSight for the first time.

### Testing application

The function `clinsight::run_app()` creates databases in the working directory, that will save user actions such as review status of study data. Depending on the settings, a credentials database will be created. When developing ClinSight settings for a specific study, it can be more useful to run ClinSight within a temporary folder, so that the required databases are created every time after closing the application. This makes it easier to prototype the application, and tweak the data/metadata for use with ClinSight. To do so, a wrapper around the `run_app()` function can be used, such as the one below.

```{r }
test_clinsight <- function(
    clinsight_data = clinsightful_data, 
    meta_data = metadata,
    clinsight_config = "test"
){
  temp_folder <- tempfile(tmpdir = tempdir())
  base_folder <- temp_folder
  if(identical(clinsight_config, "shinyproxy")){
    temp_folder <- file.path(temp_folder, "study_data")
  }
  dir.create(temp_folder, recursive = TRUE)
  saveRDS(clinsight_data, file.path(temp_folder, "study_data.rds"))
  saveRDS(meta_data, file.path(temp_folder, "metadata.rds"))
  old_config <- Sys.getenv("GOLEM_CONFIG_ACTIVE")
  Sys.setenv("GOLEM_CONFIG_ACTIVE" = clinsight_config)
  run_app(
    data_folder = base_folder, 
    credentials_pwd = "TEMP_PASSWORD",
    onStart = \(){onStop(\(){
      unlink(temp_folder, recursive = TRUE);
      Sys.setenv("GOLEM_CONFIG_ACTIVE" = old_config)
    })}
  )
}
```

With this function, we can test ClinSight with custom data and metadata, as will be explained later. Running it without changing default arguments runs ClinSight with internal test data:

```{r eval=FALSE}
# Not run:
# If evaluated, this will run ClinSight with internal test data
test_clinsight()
```

### Prepare ClinSight for use with a custom study

In order to use study data with ClinSight, the raw data needs to fulfill few specific requirements and a ClinSight metadata file needs to be customized and created (see `create_clinsight_metadata()` and `get_metadata()`. Then, if requirements are met, the data can be merged with study-specific `metadata` to create custom `ClinSight`-compatible study data.

### Raw data structure

Raw study data needs to needs to be in long format in order to use it with ClinSight, with the columns being in character vector format. The following columns are expected to be in the raw data.

|                |                                                                                                                |
|-----------------------|-------------------------------------------------|
| **Name**       | **Description**                                                                                                |
| site_code      | Identifier for study site.                                                                                     |
| subject_id     | Unique identifier for a subject                                                                                |
| event_id       | Identifies events within a study, such as study visits.                                                        |
| event_date     | The date of the event. Should be convertible from a character vector to a valid date within R.                 |
| event_repeat   | Counter containing a sequence number that increments if an event_id is repeated within the same subject.       |
| form_id        | Identifier for each form. Can be mostly ignored, since new form identifiers are set within ClinSight metadata. |
| form_repeat    | Counter containing a sequence number that increments if a form is repeated within the same subject.            |
| var            | Name of the variable to use in ClinSight. Longer/more appropriate names will be specified in metadata.         |
| item_value     | Value of the variable (`var`) in question.                                                                     |
| edit_date_time | The time at which the value was last edited. Important for efficient reviewing of the data within ClinSight.   |

As an example, we will use raw data included in the package. Note that if the column names differ, they can be adjusted in the metadata if needed, so that they will show up as in the table above after merging.

```{r}
raw_data <- get_raw_csv_data(system.file("raw_data", package = "clinsight"))
head(raw_data)
```

### Create metadata

A metadata file needs to be customized and created for each study. Use the function `create_clinsight_metadata()` to create and open a new template. The Excel template contains multiple tabs which are described below in detail. The orange tabs are mandatory and should not be removed or renamed.

![](images/metadata-tabs.png){width="587" height="35"}

#### column_names

Within the first tab, the column names of the raw data need to be specified. The columns with the names within `name_raw` will be renamed to the new name when merging metadata with raw data later. Again, orange fields should not be adjusted.

![](images/metadata-column_names.png)

#### events

Next tab contains information about study events.

![](images/metadata-events.png)

All study visits should be entered in the `event_id` column, in order to preserve the correct order of events.

The green-colored column names are optional columns. `is_regular_visit` can be used to mark a specific visit as non-regular/ not planned. Unplanned visits will not show up in the compact timeline and will not be used to increment an internal visit counter for each patient.

If needed, the name of the `event_id` can be customized using two columns. `event_label_custom` changes the event label within the compact timeline in the top right corner of the application. `event_name_custom` will change the standard `event_id` label anywhere else in the application.

Lastly, ClinSight needs to know which is the baseline event to create internal counters of how many days are passed since baseline. It assumes that the first visit in the list (which is `SCR` in the example) is the baseline visit, but this can be changed using the `is_baseline_event` column. Note that only one event can be set as baseline here.

If the number of events cannot be specified correctly beforehand, a user can also provide an `event_id_pattern` matching to create event labels and event names.

#### common_forms

This tab contains information about the variables that need to be displayed in the `Common events` tab in `ClinSight`. Together with `study_forms` and `general`, this tab contains most of the data that will show up in the app. The column `var` contains the exact name of the variable in the raw data. The item_name column shows how it will show up in the application. For common forms, there are prefixes (AE, CM, MH) that will be stripped from the item_name; these are used to provide a unique name for each variable. The `item_group` tab is the exact name of the form that will show up in the application. Lastly, `item_type` can either be continuous or other, and it controls whether visualization or only tables will be displayed. This should usually be set to `other` within study_forms. More information on the other implemented options follows in the description for the `study_forms` below.

![](images/metadata-common_forms.png){width="633"}

Note that some of the `item_name`s are colored orange, meaning that ClinSight expect these names to be present. Currently it is not recommended to change these names. If they are missing in your own data, just leave them in the metadata as is. It will be made easier to customize these names and variables in a future update.

#### study_forms

This tab contains information about the variables in the `Study data` tab in ClinSight. Mandatory columns are here `var`, `item_name`, `item_type`, and `item_group`.

![](images/metadata-study_forms.png)

Data and forms/item_groups entered in the `study_forms` tab will either show up in table form or, if all variables within an `item_group` are of `item_type` 'continuous', in interactive graphs. If all data is 'continuous', units and limits can be provided directly if these do not change within each site.

If limits are provided in the data, and especially if they can vary per study site, then there is an option within ClinSight to scale the values for each analyte to a value between 0 and 1, with 0 being the lower limit and 1 being the upper limit of the normal range, based on the normal ranges of the local laboratory. The formula used for scaling is shown below:

$$x_{scaled} = \frac{x-x_{lower}}{x_{upper}-x_{lower}}$$ *(*$x^{lower}$ is the lower limit of x and $x^{upper}$ the upper limit, according to the site-specific laboratory ranges).

In order to use this functionality, the values `item_scale` and `use_unscaled_limits` in the tab [form_level_data](#form_level_data) should both be set to `FALSE`.

#### general

This tab contains information about variables that are needed in ClinSight, but do not necessarily need to be displayed in the `Common events` or `Study data` tab. Of note that here are also a view mandatory names that are still needed for ClinSight to function. It is not advised to delete these names. If they are missing in your own data, just leave them in the metadata as is.

![](images/metadata-general.png)

#### form_level_data {#form_level_data}

This is an optional tab. If provided, the column `item_group` is mandatory. In this tab, settings can be adjusted on form level rather than setting them within the `common_forms` or `study_forms` tab.

![](images/metadata-form_level_data.png)

If a form is missing here, or one of the values `item_scale`, `use_unscaled_limits`, or `review_required` is not provided, then the defaults will be used for that form:

| item_scale | use_unscaled_limits | review_required |
|------------|---------------------|-----------------|
| `NA`       | `NA`                | `TRUE`          |

#### table_names

Can be used to get nicer names in the interactive tables in ClinSight. Current table contains mostly standard ClinSight names, but also other variable names could be included here.

![](images/metadata-table_names.png)

#### settings

Contains some miscellaneous settings, such as settings for providing custom functions when merging data with the `merge_meta_with_data()` function.

### Merge and prepare data

When metadata is adjusted to the study_specific needs, create an R object from the Excel file:

```{r }
meta_custom <- get_metadata(system.file("metadata.xlsx", package = "clinsight"))
```

Then, merge the metadata with the raw data. This will give some information and will try to throw an informative error if an incompatible change was made:

```{r}
merged_study_data <- merge_meta_with_data(raw_data, meta_custom)
```

Finally, we can start clinsight with our custom data and metadata:

```{r, eval=FALSE}
#Not run
test_clinsight(merged_study_data, meta_custom)
```

You will notice that the application shows a warning if some variables defined in the metadata are not available in the actual data, similar to the message below. It is useful to check this output carefully to see if all variable names were entered correctly.

```{r}
# Warning in check_appdata(app_data, meta) :
#   Not all variables defined in metadata are present in the data.
#              var               item_name
# 1 AE_AESER_AEOUT             SAE outcome
# 2     WHO_WHOCAT   WHO.subclassification
# 3       DMOD_DAT    DoseModificationDate
# 4      DMOD_REAS  DoseModificationReason
# 5      DMOD_DOSE DoseModificationNewDose
```

To improve and adjust the application, simply stop the application, adjust the metadata, merge it again with the data, and try again. For example, if we want to change the name of 'Systolic blood pressure' to 'SBP', we can adjust this in the Excel file and use `get_metadata()` again.

We will simulate this behavior here by manually adjusting the metadata file:

```{r}
# !It is better to adjust the Excel metadata file instead of doing this:
meta_custom$items_expanded$item_name[grepl("Systolic blood pressure", meta_custom$items_expanded$item_name)]
adjusted_study_data <- merge_meta_with_data(raw_data, meta_custom)
```

```{r eval=FALSE}
#Not run
test_clinsight(adjusted_study_data, meta_custom) 
```

If changed correctly, the name of the variable will change accordingly in the application:

![](images/clinsight-var_name_change.png){width="621"}
