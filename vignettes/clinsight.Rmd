---
title: "Introduction to ClinSight"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ClinSight}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}
library(clinsight)
```

## Test ClinSight

To get started, you can easily run ClinSight by using the function `clinsight::run_app()`, which is the main function in this package. This will start the application, and you can try out the main features using internal test data.

However, we will use a wrapper around `clinsight::run_app()` in this vignette. Reason for this is that the function creates databases in the working directory that will save user actions such as review status of study data. This is needed for use in production, but for testing purposes and for developing custom data and metadata, it is better to load all data in a temporary folder that will be cleaned up after use. The wrapper below does exactly that:

```{r }
test_clinsight <- function(
    clinsight_data = clinsightful_data, 
    meta_data = metadata,
    clinsight_config = "test"
){
  temp_folder <- tempfile(tmpdir = tempdir())
  dir.create(temp_folder, recursive = TRUE)
  saveRDS(clinsight_data, file.path(temp_folder, "study_data.rds"))
  saveRDS(meta_data, file.path(temp_folder, "metadata.rds"))
  old_config <- Sys.getenv("GOLEM_CONFIG_ACTIVE")
  Sys.setenv("GOLEM_CONFIG_ACTIVE" = clinsight_config)
  run_app(
    data_folder = temp_folder, 
    credentials_pwd = "TEMP_PASSWORD",
    onStart = \(){onStop(\(){
      unlink(temp_folder, recursive = TRUE);
      Sys.setenv("GOLEM_CONFIG_ACTIVE" = old_config)
    })}
  )
}
```

With this function, we can test ClinSight with custom data and metadata, as will be explained later. Running it without changing default arguments runs ClinSight with internal test data:

```{r eval=FALSE}
# Not run:
# If evaluated, this will run ClinSight with internal test data
test_clinsight()
```

## Create custom data and metadata

In order to use custom study data with ClinSight, the raw custom data needs to fulfill few specific requirements. Secondly, a ClinSight metadata file needs to be customized and created based on the custom data (see `create_clinsight_metadata()` and `get_metadata()`. If these requirements are met, the data can be merged with the study-specific `metadata` to successfully create custom `ClinSight`-compatible study data. All details about the metadata template can be found in the vignette Metadata `vignette("Metadata")`.

### Raw data structure

Raw study data needs to needs to be in long format in order to use it with ClinSight, with the columns being in character vector format. The following columns are expected to be in the raw data.

|                |                                                                                                                |
|------------------------|-----------------------------------------------|
| **Name**       | **Description**                                                                                                |
| site_code      | Identifier for study site.                                                                                     |
| subject_id     | Unique identifier for a subject                                                                                |
| event_id       | Identifies events within a study, such as study visits.                                                        |
| event_date     | The date of the event. Should be convertible from a character vector to a valid date within R.                 |
| event_repeat   | Counter containing a sequence number that increments if an event_id is repeated within the same subject.       |
| form_id        | Identifier for each form. Can be mostly ignored, since new form identifiers are set within ClinSight metadata. |
| form_repeat    | Counter containing a sequence number that increments if a form is repeated within the same subject.            |
| var            | Name of the variable to use in ClinSight. Longer/more appropriate names will be specified in metadata.         |
| item_value     | Value of the variable (`var`) in question.                                                                     |
| edit_date_time | The time at which the value was last edited. Important for efficient reviewing of the data within ClinSight.   |

As an example, we will use raw data included in the package. Note that if the column names differ, they can be adjusted in the metadata if needed, so that they will show up as in the table above after merging.

```{r}
raw_data <- get_raw_csv_data(system.file("raw_data", package = "clinsight"))
head(raw_data)
```

### Merge and prepare data

When metadata is adjusted to the study_specific needs, create an R object from the Excel file:

```{r }
meta_custom <- get_metadata(system.file("metadata.xlsx", package = "clinsight"))
```

Then, merge the metadata with the raw data. This will give some information and will try to throw an informative error if an incompatible change was made:

```{r}
merged_study_data <- merge_meta_with_data(raw_data, meta_custom)
```

Finally, we can start clinsight with our custom data and metadata:

```{r, eval=FALSE}
#Not run
test_clinsight(merged_study_data, meta_custom)
```

You will notice that the application shows a warning if some variables defined in the metadata are not available in the actual data, similar to the message below. It is useful to check this output carefully to see if all variable names were entered correctly.

```{r}
# Warning in check_appdata(app_data, meta) :
#   Not all variables defined in metadata are present in the data.
#              var               item_name
# 1 AE_AESER_AEOUT             SAE outcome
# 2     WHO_WHOCAT   WHO.subclassification
# 3       DMOD_DAT    DoseModificationDate
# 4      DMOD_REAS  DoseModificationReason
# 5      DMOD_DOSE DoseModificationNewDose
```

To improve and adjust the application, simply stop the application, adjust the metadata, merge it again with the data, and try again. For example, if we want to change the name of 'Systolic blood pressure' to 'SBP', we can adjust this in the Excel file and use `get_metadata()` again.

We will simulate this behavior here by manually adjusting the metadata file:

```{r}
# !It is better to adjust the Excel metadata file instead of doing this:
meta_custom$items_expanded$item_name[grepl("Systolic blood pressure", meta_custom$items_expanded$item_name)]
adjusted_study_data <- merge_meta_with_data(raw_data, meta_custom)
```

```{r eval=FALSE}
#Not run
test_clinsight(adjusted_study_data, meta_custom) 
```

If changed correctly, the name of the variable will change accordingly in the application:

![](images/clinsight-var_name_change.png){width="621"}
